<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Settings Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .settings-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .auto-play-toggle {
            background: #28a745;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            border: none;
            cursor: pointer;
            margin: 10px 0;
        }
        .auto-play-toggle.disabled {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <h1>🎤 Voice Settings Integration Test</h1>
    
    <div class="test-container">
        <h2>Voice Settings Persistence Test</h2>
        <p>This test verifies that voice settings are properly saved to and loaded from the backend API.</p>
        
        <div id="test-results"></div>
        
        <button onclick="runTests()">Run Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="test-container">
        <h2>Current Voice Settings</h2>
        <div id="current-settings" class="settings-display">
            Loading settings...
        </div>
        
        <button class="auto-play-toggle" id="auto-play-btn" onclick="toggleAutoPlay()">
            Auto-play: Loading...
        </button>
        
        <button onclick="loadSettings()">Refresh Settings</button>
        <button onclick="resetSettings()">Reset to Defaults</button>
    </div>

    <div class="test-container">
        <h2>Manual Testing</h2>
        <p>Use these controls to manually test voice settings functionality:</p>
        
        <div>
            <label>Speech Rate: <input type="range" id="speech-rate" min="0.5" max="2.0" step="0.1" value="1.0" onchange="updateSetting('speechRate', this.value)"></label>
            <span id="rate-value">1.0x</span>
        </div>
        
        <div>
            <label>Speech Volume: <input type="range" id="speech-volume" min="0" max="1" step="0.1" value="1.0" onchange="updateSetting('speechVolume', this.value)"></label>
            <span id="volume-value">100%</span>
        </div>
        
        <div>
            <label>Language: 
                <select id="language-select" onchange="updateSetting('language', this.value)">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="es-ES">Spanish (Spain)</option>
                    <option value="fr-FR">French (France)</option>
                </select>
            </label>
        </div>
    </div>

    <!-- Include voice settings module -->
    <script src="voice-settings.js"></script>

    <script>
        let voiceSettings = null;
        let testResults = [];

        // Initialize voice settings
        async function initializeVoiceSettings() {
            try {
                voiceSettings = new VoiceSettings('test_voice_settings');
                await voiceSettings.initializeForUser();
                
                // Set up listeners
                voiceSettings.addListener((action, settings) => {
                    console.log('Settings changed:', action, settings);
                    updateSettingsDisplay();
                });
                
                updateSettingsDisplay();
                addResult('Voice settings initialized successfully', 'success');
            } catch (error) {
                addResult(`Failed to initialize voice settings: ${error.message}`, 'error');
            }
        }

        function addResult(message, type = 'info') {
            const result = { message, type, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => 
                `<div class="test-result ${result.type}">
                    [${result.timestamp}] ${result.message}
                </div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            testResults = [];
            updateResultsDisplay();
        }

        async function updateSettingsDisplay() {
            if (!voiceSettings) return;
            
            const settings = voiceSettings.get();
            const display = document.getElementById('current-settings');
            
            display.innerHTML = `
                <strong>Current Voice Settings:</strong><br>
                Auto-play: ${settings.autoPlayEnabled}<br>
                Voice Name: ${settings.voiceName}<br>
                Speech Rate: ${settings.speechRate}x<br>
                Speech Pitch: ${settings.speechPitch}<br>
                Speech Volume: ${Math.round(settings.speechVolume * 100)}%<br>
                Language: ${settings.language}<br>
                Microphone Sensitivity: ${Math.round(settings.microphoneSensitivity * 100)}%<br>
                Noise Cancellation: ${settings.noiseCancellation}<br>
                Last Updated: ${new Date(settings.lastUpdated).toLocaleString()}
            `;

            // Update auto-play button
            const autoPlayBtn = document.getElementById('auto-play-btn');
            autoPlayBtn.textContent = `Auto-play: ${settings.autoPlayEnabled ? 'ON' : 'OFF'}`;
            autoPlayBtn.className = settings.autoPlayEnabled ? 'auto-play-toggle' : 'auto-play-toggle disabled';

            // Update manual controls
            document.getElementById('speech-rate').value = settings.speechRate;
            document.getElementById('rate-value').textContent = settings.speechRate + 'x';
            document.getElementById('speech-volume').value = settings.speechVolume;
            document.getElementById('volume-value').textContent = Math.round(settings.speechVolume * 100) + '%';
            document.getElementById('language-select').value = settings.language;
        }

        async function toggleAutoPlay() {
            if (!voiceSettings) return;
            
            try {
                const currentSettings = voiceSettings.get();
                const newValue = !currentSettings.autoPlayEnabled;
                
                await voiceSettings.setValue('autoPlayEnabled', newValue);
                addResult(`Auto-play ${newValue ? 'enabled' : 'disabled'}`, 'success');
            } catch (error) {
                addResult(`Failed to toggle auto-play: ${error.message}`, 'error');
            }
        }

        async function updateSetting(key, value) {
            if (!voiceSettings) return;
            
            try {
                // Convert value to appropriate type
                if (key === 'speechRate' || key === 'speechVolume') {
                    value = parseFloat(value);
                }
                
                await voiceSettings.setValue(key, value);
                addResult(`Updated ${key} to ${value}`, 'success');
            } catch (error) {
                addResult(`Failed to update ${key}: ${error.message}`, 'error');
            }
        }

        async function loadSettings() {
            if (!voiceSettings) return;
            
            try {
                await voiceSettings.syncWithBackend();
                addResult('Settings refreshed from backend', 'success');
            } catch (error) {
                addResult(`Failed to refresh settings: ${error.message}`, 'error');
            }
        }

        async function resetSettings() {
            if (!voiceSettings) return;
            
            try {
                await voiceSettings.reset();
                addResult('Settings reset to defaults', 'success');
            } catch (error) {
                addResult(`Failed to reset settings: ${error.message}`, 'error');
            }
        }

        async function runTests() {
            addResult('Starting voice settings integration tests...', 'info');
            
            if (!voiceSettings) {
                addResult('Voice settings not initialized', 'error');
                return;
            }

            try {
                // Test 1: Save and load settings
                addResult('Test 1: Save and load settings', 'info');
                const testSettings = {
                    autoPlayEnabled: true,
                    speechRate: 1.5,
                    speechVolume: 0.8,
                    language: 'en-GB'
                };

                for (const [key, value] of Object.entries(testSettings)) {
                    await voiceSettings.setValue(key, value);
                }

                const savedSettings = voiceSettings.get();
                let allMatch = true;
                for (const [key, value] of Object.entries(testSettings)) {
                    if (savedSettings[key] !== value) {
                        allMatch = false;
                        addResult(`Setting ${key} mismatch: expected ${value}, got ${savedSettings[key]}`, 'error');
                    }
                }

                if (allMatch) {
                    addResult('✓ All settings saved and loaded correctly', 'success');
                }

                // Test 2: Backend synchronization
                addResult('Test 2: Backend synchronization', 'info');
                await voiceSettings.syncWithBackend();
                addResult('✓ Backend sync completed', 'success');

                // Test 3: Settings validation
                addResult('Test 3: Settings validation', 'info');
                try {
                    await voiceSettings.setValue('speechRate', 5.0); // Invalid
                    addResult('❌ Should have rejected invalid speech rate', 'error');
                } catch (error) {
                    addResult('✓ Invalid settings properly rejected', 'success');
                }

                // Test 4: Auto-play toggle
                addResult('Test 4: Auto-play toggle', 'info');
                const originalAutoPlay = voiceSettings.get().autoPlayEnabled;
                await voiceSettings.setValue('autoPlayEnabled', !originalAutoPlay);
                const newAutoPlay = voiceSettings.get().autoPlayEnabled;
                
                if (newAutoPlay !== originalAutoPlay) {
                    addResult('✓ Auto-play toggle works correctly', 'success');
                } else {
                    addResult('❌ Auto-play toggle failed', 'error');
                }

                // Test 5: Settings persistence
                addResult('Test 5: Settings persistence simulation', 'info');
                const beforeCleanup = voiceSettings.get();
                voiceSettings.cleanupOnLogout();
                voiceSettings.restoreBasicSettings();
                const afterRestore = voiceSettings.get();
                
                // Some settings should be preserved
                if (afterRestore.speechRate === beforeCleanup.speechRate) {
                    addResult('✓ Basic settings preserved after logout cleanup', 'success');
                } else {
                    addResult('❌ Settings not properly preserved', 'error');
                }

                addResult('All tests completed!', 'success');

            } catch (error) {
                addResult(`Test failed: ${error.message}`, 'error');
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initializeVoiceSettings);
    </script>
</body>
</html>