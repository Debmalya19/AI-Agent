<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        #voice-controls-container {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 10px 0;
            min-height: 50px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Voice Assistant Debug Tool</h1>
        
        <div class="debug-section">
            <h3>1. Module Loading Status</h3>
            <div id="module-status"></div>
            <button onclick="checkModules()">Check Modules</button>
        </div>

        <div class="debug-section">
            <h3>2. Feature Toggle Status</h3>
            <div id="toggle-status"></div>
            <button onclick="checkFeatureToggles()">Check Feature Toggles</button>
        </div>

        <div class="debug-section">
            <h3>3. Voice Controls Container</h3>
            <div id="voice-controls-container">
                <!-- Voice controls should appear here -->
            </div>
            <button onclick="initializeVoiceUI()">Initialize Voice UI</button>
            <button onclick="testVoiceContainer()">Test Container</button>
        </div>

        <div class="debug-section">
            <h3>4. Browser Compatibility</h3>
            <div id="browser-status"></div>
            <button onclick="checkBrowserSupport()">Check Browser Support</button>
        </div>

        <div class="debug-section">
            <h3>5. Debug Log</h3>
            <div id="debug-log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <!-- Load voice modules -->
    <script src="/static/voice-loader.js"></script>
    <script src="/static/voice-feature-toggles.js"></script>
    <script src="/static/voice-performance-monitor.js"></script>

    <script>
        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${getLogColor(type)};">[${type.toUpperCase()}]</span> ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function getLogColor(type) {
            const colors = {
                'info': '#0c5460',
                'success': '#155724',
                'warning': '#856404',
                'error': '#721c24'
            };
            return colors[type] || '#333';
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Check if modules are loaded
        function checkModules() {
            log('Checking voice modules...');
            
            const modules = {
                'VoiceFeatureToggleManager': typeof VoiceFeatureToggleManager !== 'undefined',
                'VoiceModuleLoader': typeof VoiceModuleLoader !== 'undefined',
                'VoicePerformanceMonitor': typeof VoicePerformanceMonitor !== 'undefined',
                'initializeVoiceFeatureToggles': typeof initializeVoiceFeatureToggles !== 'undefined',
                'initializeVoiceLoader': typeof initializeVoiceLoader !== 'undefined'
            };

            let allLoaded = true;
            let statusHtml = '<h4>Module Status:</h4>';
            
            for (const [module, loaded] of Object.entries(modules)) {
                const status = loaded ? '‚úÖ' : '‚ùå';
                const type = loaded ? 'success' : 'error';
                statusHtml += `<div class="status ${type}">${status} ${module}: ${loaded ? 'Loaded' : 'Not Found'}</div>`;
                log(`${module}: ${loaded ? 'Loaded' : 'Not Found'}`, loaded ? 'success' : 'error');
                if (!loaded) allLoaded = false;
            }

            document.getElementById('module-status').innerHTML = statusHtml;
            
            if (allLoaded) {
                log('All core modules loaded successfully', 'success');
            } else {
                log('Some modules failed to load', 'error');
            }
        }

        // Check feature toggles
        function checkFeatureToggles() {
            log('Checking feature toggles...');
            
            try {
                const toggleManager = initializeVoiceFeatureToggles({
                    debugMode: true
                });

                const features = [
                    'voice_input',
                    'voice_output', 
                    'voice_settings',
                    'lazy_loading',
                    'performance_tracking'
                ];

                let statusHtml = '<h4>Feature Toggle Status:</h4>';
                
                for (const feature of features) {
                    const enabled = toggleManager.isFeatureEnabled(feature);
                    const status = enabled ? '‚úÖ' : '‚ùå';
                    const type = enabled ? 'success' : 'warning';
                    statusHtml += `<div class="status ${type}">${status} ${feature}: ${enabled ? 'Enabled' : 'Disabled'}</div>`;
                    log(`${feature}: ${enabled ? 'Enabled' : 'Disabled'}`, enabled ? 'success' : 'warning');
                }

                document.getElementById('toggle-status').innerHTML = statusHtml;
                log('Feature toggle check completed', 'success');

            } catch (error) {
                const errorMsg = `Feature toggle check failed: ${error.message}`;
                setStatus('toggle-status', errorMsg, 'error');
                log(errorMsg, 'error');
            }
        }

        // Test voice container
        function testVoiceContainer() {
            log('Testing voice controls container...');
            
            const container = document.getElementById('voice-controls-container');
            if (!container) {
                log('Voice controls container not found!', 'error');
                return;
            }

            log('Voice controls container found', 'success');
            log(`Container ID: ${container.id}`, 'info');
            log(`Container class: ${container.className}`, 'info');
            log(`Container children: ${container.children.length}`, 'info');

            // Add a test button to verify container works
            const testButton = document.createElement('button');
            testButton.textContent = 'üé§ Test Voice Button';
            testButton.style.background = '#28a745';
            testButton.onclick = () => {
                log('Test voice button clicked!', 'success');
                alert('Voice container is working!');
            };
            
            container.appendChild(testButton);
            log('Test button added to container', 'success');
        }

        // Initialize voice UI
        async function initializeVoiceUI() {
            log('Attempting to initialize voice UI...');
            
            try {
                // Check if container exists
                const container = document.getElementById('voice-controls-container');
                if (!container) {
                    throw new Error('Voice controls container not found');
                }

                // Initialize feature toggles
                const toggleManager = initializeVoiceFeatureToggles({
                    debugMode: true
                });

                // Check if voice features are enabled
                const voiceInputEnabled = toggleManager.isFeatureEnabled('voice_input');
                const voiceOutputEnabled = toggleManager.isFeatureEnabled('voice_output');
                
                if (!voiceInputEnabled && !voiceOutputEnabled) {
                    throw new Error('Voice features are disabled by feature toggles');
                }

                log('Feature toggles initialized', 'success');

                // Try to load voice modules
                if (toggleManager.isFeatureEnabled('lazy_loading')) {
                    log('Attempting lazy loading of voice modules...', 'info');
                    
                    const loader = initializeVoiceLoader({
                        baseUrl: '/static/',
                        debugMode: true,
                        enableCaching: true
                    });

                    const features = [];
                    if (voiceInputEnabled) features.push('input');
                    if (voiceOutputEnabled) features.push('output');
                    features.push('ui');

                    const loadResult = await loader.loadVoiceFeatures(features);
                    log(`Voice modules loaded: ${JSON.stringify(loadResult)}`, 'success');

                    // Wait for modules to be available
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    while (attempts < maxAttempts) {
                        if (window.VoiceSettings && window.VoiceController && window.VoiceUI) {
                            log('All voice classes are now available', 'success');
                            break;
                        }
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (attempts >= maxAttempts) {
                        throw new Error('Voice modules failed to load within timeout');
                    }

                } else {
                    log('Lazy loading disabled, checking for direct module availability...', 'info');
                    
                    if (!window.VoiceSettings || !window.VoiceController || !window.VoiceUI) {
                        throw new Error('Voice modules not available (lazy loading disabled)');
                    }
                }

                // Initialize voice components
                log('Initializing voice components...', 'info');

                // Initialize voice settings
                const voiceSettings = new VoiceSettings('debug_voice_settings');
                await voiceSettings.initializeForUser();
                log('Voice settings initialized', 'success');

                // Initialize voice controller
                const voiceController = new VoiceController({
                    onTranscript: (transcript) => log(`Voice transcript: ${transcript}`, 'info'),
                    onError: (type, message) => log(`Voice error: ${type} - ${message}`, 'error'),
                    onStatusChange: (status) => log(`Voice status: ${status}`, 'info')
                }, {
                    debugMode: true
                });
                log('Voice controller initialized', 'success');

                // Initialize voice UI
                const voiceUI = new VoiceUI(container, voiceController, {
                    showMicrophoneButton: voiceInputEnabled,
                    showPlaybackControls: voiceOutputEnabled,
                    showSettingsButton: true,
                    debugMode: true
                });
                log('Voice UI initialized successfully!', 'success');

                // Test if UI elements were created
                const uiElements = container.children.length;
                log(`Voice UI created ${uiElements} elements in container`, 'success');

            } catch (error) {
                const errorMsg = `Voice UI initialization failed: ${error.message}`;
                log(errorMsg, 'error');
                log(`Error stack: ${error.stack}`, 'error');
            }
        }

        // Check browser support
        function checkBrowserSupport() {
            log('Checking browser support for voice features...');
            
            const support = {
                'Speech Recognition': 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
                'Speech Synthesis': 'speechSynthesis' in window,
                'MediaDevices': 'mediaDevices' in navigator,
                'getUserMedia': navigator.mediaDevices && 'getUserMedia' in navigator.mediaDevices,
                'Web Audio API': 'AudioContext' in window || 'webkitAudioContext' in window,
                'Fetch API': 'fetch' in window,
                'Promises': 'Promise' in window,
                'Local Storage': 'localStorage' in window,
                'Session Storage': 'sessionStorage' in window
            };

            let statusHtml = '<h4>Browser Support:</h4>';
            let allSupported = true;

            for (const [feature, supported] of Object.entries(support)) {
                const status = supported ? '‚úÖ' : '‚ùå';
                const type = supported ? 'success' : 'error';
                statusHtml += `<div class="status ${type}">${status} ${feature}: ${supported ? 'Supported' : 'Not Supported'}</div>`;
                log(`${feature}: ${supported ? 'Supported' : 'Not Supported'}`, supported ? 'success' : 'error');
                if (!supported) allSupported = false;
            }

            document.getElementById('browser-status').innerHTML = statusHtml;
            
            if (allSupported) {
                log('All required browser features are supported', 'success');
            } else {
                log('Some browser features are not supported', 'warning');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug page loaded', 'success');
            log('Click the buttons above to test different aspects of the voice system', 'info');
        });
    </script>
</body>
</html>